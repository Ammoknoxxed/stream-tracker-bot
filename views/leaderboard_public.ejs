<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking | <%= guild.name %></title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --accent: #fbbf24; 
            --bg-card: rgba(10, 10, 15, 0.8);
        }

        body {
            background-image: linear-gradient(rgba(0, 0, 0, 0.75), rgba(0, 0, 0, 0.75)), url('/images/background.jpg');
            background-attachment: fixed;
            background-position: center;
            background-size: cover;
            background-repeat: no-repeat;
            color: white;
            min-height: 100vh;
            margin: 0;
        }

        /* --- NEUES TOOLTIP STYLING --- */
        .tooltip-inner {
            background: rgba(10, 10, 15, 0.95) !important;
            backdrop-filter: blur(10px);
            border: 1px solid var(--accent);
            color: white !important;
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            font-size: 0.8rem;
        }
        .tooltip-arrow::before { border-top-color: var(--accent) !important; border-right-color: var(--accent) !important; }

        /* SCROLL-LOGIK OHNE SICHTBARE BARS */
        .scroll-container {
            max-height: 600px; 
            overflow-y: auto;
            scrollbar-width: none; 
            -ms-overflow-style: none; 
        }
        .scroll-container::-webkit-scrollbar { display: none; }

        .sticky-thead {
            position: sticky;
            top: 0;
            background: #0a0a0f;
            z-index: 10;
        }

        .leaderboard-container { max-width: 1000px; margin: 40px auto; }
        
        .glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(10, 10, 15, 0.85) 100%) !important;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.12) !important;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), inset 0 0 1px rgba(255, 255, 255, 0.1);
        }

        .username-bright {
            color: #ffffff !important;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .rank-name-bright {
            font-weight: 800;
            text-transform: uppercase;
            text-shadow: 0px 0px 3px rgba(0,0,0,1), 1px 1px 0px rgba(0,0,0,0.5);
            letter-spacing: 0.5px;
        }

/* --- OPTIMIERTES PODIUM STYLING --- */
        .top-three { display: flex; justify-content: center; align-items: flex-end; gap: 20px; margin-bottom: 60px; padding-top: 40px; }
        
        .podium-card { 
            padding: 20px; text-align: center; position: relative; transition: 0.3s; 
            overflow: hidden; cursor: help; border-width: 2px !important; 
        }
        
        /* Der Glanz-Effekt gilt jetzt für ALLE Karten (podium-card) */
        .podium-card::after {
            content: ""; position: absolute; top: 0; left: -150%; width: 60%; height: 100%;
            background: linear-gradient(to right, transparent 0%, rgba(255, 255, 255, 0.15) 50%, transparent 100%); 
            transform: skewX(-25deg); animation: sheen 4s infinite; pointer-events: none;
        }
        
        .podium-card:hover { 
            transform: translateY(-15px) scale(1.02); 
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
            /* Border-Farbe bleibt beim Hover die jeweilige Rang-Farbe */
        }
        
        /* Platz 1 - GOLD */
        .podium-1 { order: 2; width: 240px; height: 360px; border: 2px solid #fbbf24 !important; box-shadow: 0 0 30px rgba(251, 191, 36, 0.3); }
        .podium-1 .podium-avatar { width: 110px; height: 110px; border-color: #fbbf24; box-shadow: 0 0 20px rgba(251, 191, 36, 0.5); }
        .podium-1:hover { border-color: #fbbf24 !important; }

        /* Platz 2 - SILBER */
        .podium-2 { order: 1; width: 200px; height: 310px; border: 2px solid #e5e7eb !important; box-shadow: 0 0 20px rgba(229, 231, 235, 0.2); }
        .podium-2 .podium-avatar { border-color: #e5e7eb; }
        .podium-2:hover { border-color: #e5e7eb !important; }

        /* Platz 3 - BRONZE */
        .podium-3 { order: 3; width: 200px; height: 310px; border: 2px solid #d97706 !important; box-shadow: 0 0 20px rgba(217, 119, 6, 0.2); }
        .podium-3 .podium-avatar { border-color: #d97706; }
        .podium-3:hover { border-color: #d97706 !important; }

        .avatar-wrapper { position: relative; display: inline-block; margin-bottom: 15px; z-index: 5; }
        .podium-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #fff; transition: 0.3s; }
        
        .rank-badge-podium { position: absolute; bottom: -5px; right: -5px; width: 45px; height: 45px; object-fit: contain; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5)); z-index: 2; }
        .podium-1 .rank-badge-podium { width: 55px; height: 55px; }

        .crown-icon { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); font-size: 2.2rem; z-index: 10; }
        
        @keyframes sheen { 0% { left: -150%; } 30% { left: 150%; } 100% { left: 150%; } }

        .glow-streaming { border-color: #ff0055 !important; box-shadow: 0 0 15px rgba(255, 0, 85, 0.6); animation: pulse-border 2s infinite; }
        @keyframes pulse-border { 0%, 100% { box-shadow: 0 0 5px rgba(255, 0, 85, 0.5); } 50% { box-shadow: 0 0 20px rgba(255, 0, 85, 0.9); } }
        
        .rank-icon-list { width: 35px; height: 35px; margin-right: 10px; object-fit: contain; }

        .rank-icon-live {
            width: 40px;
            height: 40px;
            object-fit: contain;
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.2));
        }

        .rank-card { 
            background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 12px; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: default;
        }

        .rank-icon-roadmap { width: 80px; height: 80px; margin-bottom: 10px; object-fit: contain; transition: all 0.4s ease; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }

        .rank-card:hover {
            background: rgba(255, 255, 255, 0.08); transform: translateY(-12px); border-color: var(--hover-color) !important;
            box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.5), 0 0 20px -5px var(--hover-color);
        }

        .rank-card:hover .rank-icon-roadmap { filter: drop-shadow(0 0 15px var(--hover-color)); animation: floatingShake 2s ease-in-out infinite; }

        @keyframes floatingShake {
            0% { transform: scale(1.2) translateY(0) rotate(0deg); }
            15% { transform: scale(1.2) translateY(-4px) rotate(-3deg); }
            30% { transform: scale(1.2) translateY(-7px) rotate(3deg); }
            45% { transform: scale(1.2) translateY(-9px) rotate(-3deg); }
            60% { transform: scale(1.2) translateY(-7px) rotate(3deg); }
            80% { transform: scale(1.2) translateY(-4px) rotate(-1deg); }
            100% { transform: scale(1.2) translateY(0) rotate(0deg); }
        }
        
        .progress-custom { 
            height: 6px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 10px; 
            overflow: hidden; 
            margin-top: 5px; 
        }

        .progress-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            background-color: var(--accent); /* Fallback-Farbe */
        }

        .table { --bs-table-bg: transparent; color: white !important; }
        .table thead th { color: var(--accent) !important; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; border-bottom: 2px solid rgba(251, 191, 36, 0.2); }
        .text-accent { color: var(--accent) !important; }
        .opacity-50 { opacity: 0.7 !important; }

        .scroll-container td.opacity-50 { color: var(--accent) !important; opacity: 1 !important; font-weight: bold; }

        .progress-bar-glow { animation: progress-pulse 1.5s infinite; }

        @keyframes progress-pulse {
            0% { box-shadow: 0 0 5px var(--accent); filter: brightness(1); }
            50% { box-shadow: 0 0 15px var(--accent); filter: brightness(1.3); }
            100% { box-shadow: 0 0 5px var(--accent); filter: brightness(1); }
        }
        .next-rank-text { color: var(--accent) !important; opacity: 0.9 !important; font-weight: 600; }

        .table-hover tbody tr:hover { background: rgba(251, 191, 36, 0.08) !important; transition: background 0.2s ease; cursor: help; }

        body { overflow-x: hidden; }

        @keyframes fadeInRow { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

        .table tbody tr { animation: fadeInRow 0.5s ease forwards; opacity: 0; }
        .table tbody tr:nth-child(1) { animation-delay: 0.1s; }
        .table tbody tr:nth-child(2) { animation-delay: 0.15s; }
        .table tbody tr:nth-child(3) { animation-delay: 0.2s; }
        .table tbody tr:nth-child(n+4) { animation-delay: 0.3s; }

        .ranking-content::after {
            content: ""; display: block; width: 80%; height: 1px;
            background: linear-gradient(to right, transparent, var(--accent), transparent);
            margin: 40px auto; opacity: 0.3;
        }

        .podium-1 .podium-avatar { animation: avatar-glow 3s infinite alternate; }

        @keyframes avatar-glow {
            from { box-shadow: 0 0 10px rgba(251, 191, 36, 0.4); }
            to { box-shadow: 0 0 25px rgba(251, 191, 36, 0.8); }
        }

        @media (max-width: 768px) {
            .top-three { flex-direction: column; align-items: center; gap: 50px; }
            .podium-1 { order: 1; }
            .podium-2 { order: 2; }
            .podium-3 { order: 3; }
            .podium-card { width: 90% !important; height: auto !important; }
        }

        .particles-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .particle { position: absolute; background: var(--accent); border-radius: 50%; opacity: 0.3; filter: blur(2px); animation: floatUp 15s linear infinite; }

        @keyframes floatUp {
            0% { transform: translateY(110vh) translateX(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% { transform: translateY(-20vh) translateX(100px) rotate(360deg); opacity: 0; }
        }

/* --- NEUE SUCHFUNKTION STYLE --- */
        .search-wrapper {
            position: relative;
            max-width: 250px;
            margin: 0 0 15px auto; /* Rechtsbündig */
        }
        .search-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 6px 15px 6px 35px;
            color: white;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            width: 100%;
        }
        .search-input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.2);
        }
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            color: var(--accent);
            opacity: 0.6;
        }
        .d-none-search { display: none !important; }

        /* --- ANIMATION FÜR DAS LIVE-ICON --- */
        .fa-beat {
            animation: fa-beat-animation 2s infinite ease-in-out;
        }

        @keyframes fa-beat-animation {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }

        /* --- OPTIONAL: ABSTAND FÜR DIE LIVE-SEKTION --- */
        .live-now-section {
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="particles-container" id="particles"></div>

<% 
const ranks = [
    { min: 60000, name: "GOD OF MAX WIN", color: "#ffffff", img: "19.png" },
    { min: 45000, name: "Casino Imperator", color: "#ff4500", img: "18.png" },
    { min: 30000, name: "Jackpot Legende", color: "#f1c40f", img: "17.png" },
    { min: 20000, name: "Haus Elite", color: "#d35400", img: "16.png" },
    { min: 15000, name: "Zucker Baron", color: "#e91e63", img: "15.png" },
    { min: 10000, name: "High Roller", color: "#8e44ad", img: "14.png" },
    { min: 7500,  name: "Vollbild Jäger", color: "#00d2ff", img: "13.png" },
    { min: 5000,  name: "Multi König", color: "#1a5276", img: "12.png" },
    { min: 3500,  name: "Scatter Profi", color: "#2980b9", img: "11.png" },
    { min: 2500,  name: "Bonus Shopper", color: "#3498db", img: "10.png" },
    { min: 1800,  name: "Risiko Experte", color: "#145a32", img: "9.png" },
    { min: 1200,  name: "Big Gambler", color: "#1f8b4c", img: "8.png" },
    { min: 800,   name: "Rejuicer", color: "#1db954", img: "7.png" },
    { min: 500,   name: "Bonus Magnet", color: "#2ecc71", img: "6.png" },
    { min: 300,   name: "Stammgast", color: "#e5e4e2", img: "5.png" },
    { min: 150,   name: "Dauerdreher", color: "#dcddde", img: "4.png" },
    { min: 60,    name: "Walzen Flüsterer", color: "#7f8c8d", img: "3.png" },
    { min: 20,    name: "Glücksjäger", color: "#bdc3c7", img: "2.png" },
    { min: 0,     name: "Casino Gast", color: "#95a5a6", img: "1.png" }
];

const getRankInfo = (mins) => {
    // Finde den aktuellen Rang (das erste Element, dessen min <= mins ist)
    const current = ranks.find(r => mins >= r.min) || ranks[ranks.length - 1];
    const nextIndex = ranks.indexOf(current) - 1;
    const next = nextIndex >= 0 ? ranks[nextIndex] : null;
    
    let progress = 100;
    if (next) {
        // DIFFERENZ-LOGIK:
        // Wir berechnen, wie weit man ÜBER dem aktuellen Minimum ist,
        // im Verhältnis zur Spanne bis zum nächsten Minimum.
        const rangeNeeded = next.min - current.min;
        const progressInRange = mins - current.min;
        progress = Math.floor((progressInRange / rangeNeeded) * 100);
        
        // Sicherheitscheck (darf nicht unter 0 oder über 100 fallen)
        progress = Math.max(0, Math.min(100, progress));
    }
    return { current, next, progress };
};

const formatFullTime = (totalMins) => {
    const hours = Math.floor(totalMins / 60);
    const mins = Math.floor(totalMins % 60);
    return hours > 0 ? `${hours} Std. ${mins} Min.` : `${mins} Min.`;
};

function renderLeaderboard(userList, timeKey) { %>
    <% if(userList.length >= 1) { %>
    <div class="top-three">
        <% userList.slice(0, 3).forEach((user, index) => { 
            const info = getRankInfo(user[timeKey]);
        %>
            <div class="podium-card podium-<%= index + 1 %> glass-card" 
                 data-bs-toggle="tooltip" 
                 data-bs-placement="top"
                 data-bs-title="<%= info.next ? 'Noch ' + formatFullTime(info.next.min - user[timeKey]) + ' bis zum nächsten Rang' : 'Höchster Rang erreicht!' %>">
                
                <% if(index === 0) { %>
                    <i class="fas fa-crown crown-icon" style="color: #fbbf24; text-shadow: 0 0 15px rgba(251, 191, 36, 0.6);"></i>
                <% } else if(index === 1) { %>
                    <i class="fas fa-medal crown-icon" style="color: #e5e7eb; text-shadow: 0 0 15px rgba(229, 231, 235, 0.5);"></i>
                <% } else if(index === 2) { %>
                    <i class="fas fa-medal crown-icon" style="color: #d97706; text-shadow: 0 0 15px rgba(217, 119, 6, 0.5);"></i>
                <% } %>

                <div class="avatar-wrapper">
                    <img src="<%= user.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png' %>" 
                         class="podium-avatar <%= user.isStreaming ? 'glow-streaming' : '' %>">
                    <img src="/images/ranks/<%= info.current.img %>" class="rank-badge-podium">
                </div>

                <h4 class="mb-0 text-truncate username-bright"><%= user.nickname || user.displayName || user.username %></h4>
                <div class="opacity-50 mb-2" style="font-size: 0.7rem; font-weight: 400; line-height: 1;">@<%= user.username %></div>

                <div class="rank-name-bright" style="color: <%= info.current.color %>; font-size: 0.75rem; margin-bottom: 5px;">
                    <%= info.current.name %>
                </div>

                <% if(user.isStreaming) { %><span class="badge mb-2" style="background-color: #ff0055;">LIVE</span><% } %>
                
                <div class="text-accent fw-bold live-timer" data-base="<%= user.totalMinutes %>" data-start="<%= user.isStreaming ? user.lastStreamStart : 'null' %>">
                    <%= formatFullTime(user[timeKey]) %>
                </div>

                <% if(info.next) { %>
                    <div class="progress-custom mx-auto mt-2" style="width: 80%; height: 5px;">
                        <div class="progress-bar <%= info.progress > 80 ? 'progress-bar-glow' : '' %>" 
                             style="width: <%= info.progress %>%; background: <%= info.current.color %>; box-shadow: 0 0 10px <%= info.current.color %>;">
                        </div>
                    </div>
                <% } %>

                <div class="small mt-2 fw-bold" style="color: <%= info.current.color %>; filter: brightness(1.2);">Platz <%= index + 1 %></div>
            </div>
        <% }) %>
    </div>
    <% } %>

    <div class="search-wrapper">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="userSearch" class="search-input" placeholder="User suchen...">
    </div>

    <div class="glass-card overflow-hidden">
        <div class="scroll-container">
            <table class="table table-hover align-middle mb-0 text-white" id="leaderboardTable">
                <thead class="sticky-thead bg-black">
                    <tr>
                        <th class="ps-4 py-3">#</th>
                        <th>User & Rang</th>
                        <th class="text-end pe-4">Zeit</th>
                    </tr>
                </thead>
                <tbody>
                    <% userList.slice(3).forEach((user, index) => { 
                        const info = getRankInfo(user[timeKey]);
                    %>
                    <tr class="border-bottom border-white border-opacity-10" 
                        data-bs-toggle="tooltip" 
                        data-bs-placement="right"
                        data-bs-title="<%= info.next ? info.progress + '% geschafft! Noch ' + formatFullTime(info.next.min - user[timeKey]) + ' bis ' + info.next.name : 'Höchster Rang erreicht!' %>">
                        
                        <td class="ps-4 opacity-50">#<%= index + 4 %></td>
                        
                        <td class="d-flex align-items-center py-3">
                            <img src="<%= user.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png' %>" 
                                 style="width: 40px; height: 40px; border-radius: 50%;" 
                                 class="me-3 border <%= user.isStreaming ? 'glow-streaming' : 'border-secondary' %>">
                            
                            <div class="flex-grow-1" style="max-width: 280px;">
                                <div class="d-flex align-items-center mb-1">
                                    <div class="d-flex flex-column">
                                        <span class="username-bright leading-tight"><%= user.nickname || user.displayName || user.username %></span>
                                        <span class="opacity-50" style="font-size: 0.65rem; font-weight: 400; margin-top: -2px;">@<%= user.username %></span>
                                    </div>
                                    <% if(user.isStreaming) { %>
                                        <span class="badge ms-2" style="background-color: #ff0055; font-size: 0.5rem;">LIVE</span>
                                    <% } %>
                                </div>

                                <div class="d-flex align-items-center mt-1">
                                    <img src="/images/ranks/<%= info.current.img %>" class="rank-icon-list">
                                    <div class="w-100">
                                        <div class="d-flex justify-content-between" style="font-size: 0.65rem;">
                                            <span class="rank-name-bright" style="color: <%= info.current.color %>;"><%= info.current.name %></span>
                                            <% if(info.next) { %>
                                                <span class="next-rank-text" style="font-size: 0.6rem;">Nächster Rang ab: <%= formatFullTime(info.next.min) %></span>
                                            <% } %>
                                        </div>
                                        <% if(info.next) { %>
                                            <div class="progress-custom">
                                                <div class="progress-bar <%= info.progress > 80 ? 'progress-bar-glow' : '' %>" 
                                                     style="width: <%= info.progress %>%; background: <%= info.current.color %>; box-shadow: 0 0 10px <%= info.current.color %>;">
                                                </div>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </td>

                        <td class="text-end pe-4 text-accent fw-bold live-timer" data-base="<%= user.totalMinutes %>" data-start="<%= user.isStreaming ? user.lastStreamStart : 'null' %>">
                            <%= formatFullTime(user[timeKey]) %>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>
<% } %>

<div class="container leaderboard-container">
    <div class="text-center mb-5 mt-4">
        <% if(guild.icon) { %>
            <img src="https://cdn.discordapp.com/icons/<%= guild.id %>/<%= guild.icon %>.png" 
                 class="rounded-circle mb-3 shadow-lg border" 
                 style="width: 80px; height: 80px; border-width: 3px !important; border-color: var(--accent) !important;">
        <% } %>
        <h1 class="display-5 fw-bold text-accent" style="letter-spacing: 3px; text-shadow: 0 0 20px rgba(251, 191, 36, 0.4);">STREAM RANKING</h1>
        <p class="opacity-75 text-uppercase fw-light" style="letter-spacing: 5px;"><%= guild.name %></p>
    </div>

<div class="ranking-content">
    <% 
        // 1. Filtern: Wer ist gerade live? (Die Logik bleibt oben)
        const liveUsers = allTimeLeaderboard.filter(u => u.isStreaming); 
    %>

    <% renderLeaderboard(allTimeLeaderboard, 'effectiveTotal'); %>

    <% if (liveUsers.length > 0) { %>
        <div class="live-now-section mb-5 mt-5"> <h3 class="text-accent mb-4" style="letter-spacing: 2px;">
                <i class="fas fa-broadcast-tower fa-beat me-2" style="color: #ff0055;"></i> AKTUELL LIVE
            </h3>
            
            <div class="row g-3">
                <% liveUsers.forEach(user => { 
                    const info = getRankInfo(user.effectiveTotal);
                %>
                    <div class="col-12 col-md-6 col-lg-4">
                        <a href="https://discord.com/channels/<%= guild.id %>/<%= user.voiceChannelId %>" target="_blank" class="text-decoration-none">
                            <div class="glass-card p-3 d-flex align-items-center border-start border-4" style="border-left-color: #ff0055 !important; transition: all 0.3s ease;">
                                <div class="position-relative me-3">
                                    <img src="<%= user.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png' %>" 
                                         class="rounded-circle glow-streaming" 
                                         style="width: 55px; height: 55px; object-fit: cover; border: 2px solid #ff0055;">
                                    <span class="position-absolute bottom-0 end-0 badge rounded-pill bg-danger" style="font-size: 0.5rem; border: 1px solid black;">LIVE</span>
                                </div>
                                
                                <div class="flex-grow-1 overflow-hidden">
                                    <div class="username-bright text-truncate" style="font-size: 1rem;"><%= user.nickname || user.username %></div>
                                    <div class="text-accent fw-bold live-timer" 
                                         data-base="<%= user.totalMinutes %>" 
                                         data-start="<%= user.lastStreamStart %>" 
                                         style="font-size: 0.85rem;">
                                        <%= formatFullTime(user.effectiveTotal) %>
                                    </div>
                                    <div class="text-white-50 mt-1 d-flex align-items-center" style="font-size: 0.65rem; transition: color 0.3s ease;">
                                        <i class="fas fa-external-link-alt me-1" style="font-size: 0.6rem;"></i> 
                                        <span>Zum Stream springen</span>
                                    </div>
                                </div> <div class="ms-3 d-flex align-items-center justify-content-center" style="width: 50px; min-width: 50px;">
                                    <img src="/images/ranks/<%= info.current.img %>" 
                                         alt="<%= info.current.name %>"
                                         style="width: 100%; height: 45px; object-fit: contain; filter: drop-shadow(0 0 8px rgba(255,255,255,0.15));">
                                </div>
                                
                            </div> </a>
                    </div>
                <% }) %>
            </div>
            
            <div class="mt-5" style="height: 1px; background: linear-gradient(to right, transparent, rgba(251, 191, 36, 0.3), transparent);"></div>
        </div>
    <% } %>

    <div class="mt-5 p-4 glass-card border-0 shadow-lg text-center">
        <h5 class="text-accent mb-4 fw-bold text-uppercase" style="letter-spacing: 2px;">Rollen Roadmap</h5>
        <div class="row g-4 justify-content-center">
            <% [...ranks].reverse().forEach(r => { %>
                <div class="col-6 col-md-3 col-lg-2">
                    <div class="rank-card p-3 h-100 d-flex flex-column align-items-center" style="--hover-color: <%= r.color %>;">
                        <img src="/images/ranks/<%= r.img %>" class="rank-icon-roadmap">
                        <div class="rank-name-bright" style="color: <%= r.color %>; font-size: 0.75rem; line-height: 1.2;">
                            <%= r.name %>
                        </div>
                        <div class="mt-1 small opacity-50" style="font-size: 0.65rem;">
                            <%= formatFullTime(r.min) %>
                        </div>
                    </div>
                </div>
            <% }) %>
        </div>
    </div>
</div> </div> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Diese Funktion startet erst, wenn das HTML fertig geladen ist
    document.addEventListener('DOMContentLoaded', function () {
        
        // 1. Tooltips aktivieren
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl, {
            delay: { "show": 100, "hide": 100 }
        }));

        // --- NEU: Verbesserte Suchfunktion ---
        const searchInput = document.getElementById('userSearch');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const tableRows = document.querySelectorAll('#leaderboardTable tbody tr');

                tableRows.forEach(row => {
                    // Sucht jetzt im gesamten Text der Zeile (DisplayName, @Tag, Rangname etc.)
                    const rowText = row.innerText.toLowerCase();
                    
                    if (rowText.includes(searchTerm)) {
                        row.classList.remove('d-none-search');
                    } else {
                        row.classList.add('d-none-search');
                    }
                });
            });
        }

        // 2. Partikel und Live-Timer initialisieren
        createParticles(); 
        updateLive();
    });

    function createParticles() {
        const container = document.getElementById('particles');
        if(!container) return;
        const particleCount = 15; 
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            const size = Math.random() * 5 + 2 + 'px';
            particle.style.width = size;
            particle.style.height = size;
            particle.style.left = Math.random() * 100 + 'vw';
            particle.style.animationDuration = Math.random() * 10 + 10 + 's';
            particle.style.animationDelay = Math.random() * 15 + 's';
            container.appendChild(particle);
        }
    }

    function formatTimeJS(totalMins) {
        const h = Math.floor(totalMins / 60);
        const m = Math.floor(totalMins % 60);
        return h > 0 ? h + " Std. " + m + " Min." : m + " Min.";
    }
    
    function updateLive() {
        const now = new Date();
        document.querySelectorAll('.live-timer').forEach(el => {
            const startStr = el.getAttribute('data-start');
            const base = parseInt(el.getAttribute('data-base'));
            if(startStr && startStr !== 'null') {
                const diff = Math.floor((now - new Date(startStr)) / 60000);
                if(diff >= 0) {
                    el.innerText = formatTimeJS(base + diff);
                }
            }
        });
    }

    // Intervalle laufen außerhalb
    setInterval(updateLive, 10000);
    setTimeout(() => { window.location.reload(); }, 300000);
</script>
</body>
</html>
