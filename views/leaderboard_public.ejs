<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking | <%= guild.name %></title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/style.css">
    <style>
        :root { --accent: #fbbf24; --bg-card: rgba(20, 20, 30, 0.6); }
        .leaderboard-container { max-width: 1000px; margin: 40px auto; }
        
        /* PODIUM STYLES */
        .top-three { display: flex; justify-content: center; align-items: flex-end; gap: 20px; margin-bottom: 60px; padding-top: 20px; }
        .podium-card { 
            background: var(--bg-card); backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.1); border-radius: 20px;
            padding: 20px; text-align: center; position: relative; transition: 0.3s;
        }
        .podium-card:hover { transform: translateY(-10px); border-color: var(--accent); }
        .podium-1 { order: 2; width: 240px; height: 360px; border: 2px solid #fbbf24; box-shadow: 0 0 30px rgba(251, 191, 36, 0.2); }
        .podium-2 { order: 1; width: 200px; height: 300px; }
        .podium-3 { order: 3; width: 200px; height: 300px; }

        /* AVATAR & RANK BADGE KOMBI */
        .avatar-wrapper { position: relative; display: inline-block; margin-bottom: 15px; }
        .podium-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #fff; transition: 0.3s; }
        .podium-1 .podium-avatar { width: 110px; height: 110px; border-color: #fbbf24; }
        
        .rank-badge-podium {
            position: absolute; bottom: -5px; right: -5px;
            width: 40px; height: 40px;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5));
            z-index: 2;
        }
        .podium-1 .rank-badge-podium { width: 50px; height: 50px; }

        .crown-icon { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); font-size: 2.2rem; }
        .glow-streaming { border-color: #ff0055 !important; box-shadow: 0 0 15px rgba(255, 0, 85, 0.6); animation: pulse-border 2s infinite; }
        @keyframes pulse-border { 0%, 100% { box-shadow: 0 0 5px rgba(255, 0, 85, 0.5); } 50% { box-shadow: 0 0 20px rgba(255, 0, 85, 0.9); } }
        
        /* ROADMAP & LISTE */
        .rank-icon-list { width: 30px; height: 30px; margin-right: 10px; }
        .rank-icon-roadmap { width: 60px; height: 60px; margin-bottom: 10px; transition: transform 0.3s; }
        .rank-card:hover .rank-icon-roadmap { transform: scale(1.2) rotate(5deg); }
        
        .progress-custom { height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .rank-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 12px; transition: all 0.3s ease; }
    </style>
</head>
<body>

<% 
const ranks = [
    { min: 18000, name: "GOD OF MAX WIN", color: "#ffffff", img: "19.png" },
    { min: 16800, name: "Casino Imperator", color: "#ff4500", img: "18.png" },
    { min: 15600, name: "Jackpot Legende", color: "#f1c40f", img: "17.png" },
    { min: 14100, name: "Haus Elite", color: "#d35400", img: "16.png" },
    { min: 12300, name: "Zucker Baron", color: "#e91e63", img: "15.png" },
    { min: 10500, name: "High Roller", color: "#8e44ad", img: "14.png" },
    { min: 8700,  name: "Vollbild Jäger", color: "#00d2ff", img: "13.png" },
    { min: 7020,  name: "Multi König", color: "#1a5276", img: "12.png" },
    { min: 5520,  name: "Scatter Profi", color: "#2980b9", img: "11.png" },
    { min: 4200,  name: "Bonus Shopper", color: "#3498db", img: "10.png" },
    { min: 3120,  name: "Risiko Experte", color: "#145a32", img: "9.png" },
    { min: 2220,  name: "Big Gambler", color: "#1f8b4c", img: "8.png" },
    { min: 1500,  name: "Rejuicer", color: "#1db954", img: "7.png" },
    { min: 960,   name: "Bonus Magnet", color: "#2ecc71", img: "6.png" },
    { min: 540,   name: "Stammgast", color: "#e5e4e2", img: "5.png" },
    { min: 240,   name: "Dauerdreher", color: "#dcddde", img: "4.png" },
    { min: 90,    name: "Walzen Flüsterer", color: "#7f8c8d", img: "3.png" },
    { min: 30,    name: "Glücksjäger", color: "#bdc3c7", img: "2.png" },
    { min: 0,     name: "Casino Gast", color: "#95a5a6", img: "1.png" }
];

const getRankInfo = (mins) => {
    const current = ranks.find(r => mins >= r.min) || ranks[ranks.length - 1];
    const nextIndex = ranks.indexOf(current) - 1;
    const next = nextIndex >= 0 ? ranks[nextIndex] : null;
    let progress = 100;
    if (next) progress = Math.floor(((mins - current.min) / (next.min - current.min)) * 100);
    return { current, next, progress };
};

const formatFullTime = (totalMins) => {
    const hours = Math.floor(totalMins / 60);
    const mins = Math.floor(totalMins % 60);
    return hours > 0 ? `${hours} Std. ${mins} Min.` : `${mins} Min.`;
};
%>

<div class="container leaderboard-container">
    <div class="text-center mb-5 mt-4">
        <% if(guild.icon) { %>
            <img src="https://cdn.discordapp.com/icons/<%= guild.id %>/<%= guild.icon %>.png" 
                 class="rounded-circle mb-3 shadow-lg border border-accent" 
                 style="width: 80px; height: 80px; border-width: 3px !important; border-color: var(--accent) !important;">
        <% } %>
        <h1 class="display-5 fw-bold text-accent" style="letter-spacing: 3px; color: var(--accent);">STREAM RANKING</h1>
        <p class="opacity-75 text-uppercase fw-light"><%= guild.name %></p>
    </div>

    <% if(trackedUsers.length >= 1) { %>
    <div class="top-three">
        <% trackedUsers.slice(0, 3).forEach((user, index) => { 
            const info = getRankInfo(user.totalMinutes);
            let displayMins = user.totalMinutes;
            if(user.isStreaming && user.lastStreamStart) {
                displayMins += Math.floor((new Date() - new Date(user.lastStreamStart)) / 60000);
            }
        %>
            <div class="podium-card podium-<%= index + 1 %> glass-card">
                <% if(index === 0) { %>
                    <i class="fas fa-crown crown-icon" style="color: #fbbf24; text-shadow: 0 0 15px rgba(251, 191, 36, 0.6);"></i>
                <% } %>

                <div class="avatar-wrapper">
                    <img src="<%= user.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png' %>" 
                         class="podium-avatar <%= user.isStreaming ? 'glow-streaming' : '' %>">
                    <img src="/images/ranks/<%= info.current.img %>" class="rank-badge-podium">
                </div>

                <h4 class="mb-1 text-truncate"><%= user.username %></h4>
                <div style="color: <%= info.current.color %>; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; margin-bottom: 5px;">
                    <%= info.current.name %>
                </div>
                <% if(user.isStreaming) { %><span class="badge badge-live mb-2">LIVE</span><% } %>
                <div class="text-accent fw-bold live-timer" data-base="<%= user.totalMinutes %>" data-start="<%= user.isStreaming ? user.lastStreamStart : 'null' %>">
                    <%= formatFullTime(displayMins) %>
                </div>
                <div class="small opacity-50 mt-1">Platz <%= index + 1 %></div>
            </div>
        <% }) %>
    </div>
    <% } %>

    <div class="glass-card overflow-hidden">
        <table class="table table-hover align-middle mb-0 text-white">
            <thead class="bg-dark bg-opacity-50">
                <tr>
                    <th class="ps-4 py-3">#</th>
                    <th>User & Rang</th>
                    <th class="text-end pe-4">Gesamtzeit</th>
                </tr>
            </thead>
            <tbody>
                <% trackedUsers.slice(3).forEach((user, index) => { 
                    const info = getRankInfo(user.totalMinutes);
                %>
                <tr class="border-bottom border-secondary border-opacity-10">
                    <td class="ps-4 opacity-50">#<%= index + 4 %></td>
                    <td class="d-flex align-items-center py-3">
                        <img src="<%= user.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png' %>" 
                             style="width: 40px; height: 40px; border-radius: 50%;" 
                             class="me-3 border <%= user.isStreaming ? 'glow-streaming' : 'border-secondary' %>">
                        <div class="flex-grow-1" style="max-width: 280px;">
                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-2"><%= user.username %></span>
                                <% if(user.isStreaming) { %><span class="badge badge-live" style="font-size: 0.5rem;">LIVE</span><% } %>
                            </div>
                            <div class="d-flex align-items-center mt-1">
                                <img src="/images/ranks/<%= info.current.img %>" class="rank-icon-list">
                                <div class="w-100">
                                    <div class="d-flex justify-content-between" style="font-size: 0.65rem;">
                                        <span style="color: <%= info.current.color %>; font-weight: 800;"><%= info.current.name %></span>
                                        <% if(info.next) { %><span class="opacity-50">Next: <%= formatFullTime(info.next.min) %></span><% } %>
                                    </div>
                                    <% if(info.next) { %>
                                    <div class="progress-custom">
                                        <div class="progress-bar" style="width: <%= info.progress %>%; background: <%= info.current.color %>;"></div>
                                    </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="text-end pe-4 text-accent fw-bold live-timer" data-base="<%= user.totalMinutes %>" data-start="<%= user.isStreaming ? user.lastStreamStart : 'null' %>">
                        <%= formatFullTime(user.totalMinutes) %>
                    </td>
                </tr>
                <% }) %>
            </tbody>
        </table>
    </div>

    <div class="mt-5 p-4 glass-card border-0 shadow-lg text-center">
        <h5 class="text-accent mb-4 fw-bold text-uppercase">Rollen Roadmap</h5>
        <div class="row g-3 justify-content-center">
            <% [...ranks].reverse().forEach(r => { %>
                <div class="col-6 col-md-4 col-lg-2">
                    <div class="rank-card p-3 h-100 d-flex flex-column align-items-center">
                        <img src="/images/ranks/<%= r.img %>" class="rank-icon-roadmap">
                        <div style="color: <%= r.color %>; font-size: 0.7rem; font-weight: 800; line-height: 1;"><%= r.name %></div>
                        <div class="mt-1 small opacity-50" style="font-size: 0.6rem;"><%= formatFullTime(r.min) %></div>
                    </div>
                </div>
            <% }) %>
        </div>
    </div>
</div>

<script>
    function formatTimeJS(totalMins) {
        const h = Math.floor(totalMins / 60);
        const m = Math.floor(totalMins % 60);
        return h > 0 ? h + " Std. " + m + " Min." : m + " Min.";
    }
    function updateLive() {
        const now = new Date();
        document.querySelectorAll('.live-timer').forEach(el => {
            const startStr = el.getAttribute('data-start');
            const base = parseInt(el.getAttribute('data-base'));
            if(startStr && startStr !== 'null') {
                const diff = Math.floor((now - new Date(startStr)) / 60000);
                if(diff >= 0) el.innerText = formatTimeJS(base + diff);
            }
        });
    }
    setInterval(updateLive, 10000);
    setTimeout(() => { window.location.reload(); }, 300000);
</script>
</body>
</html>
