<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking | <%= guild.name %></title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --accent: #fbbf24; 
            --bg-card: rgba(10, 10, 15, 0.85);
        }

        body {
            background-image: linear-gradient(rgba(0, 0, 0, 0.75), rgba(0, 0, 0, 0.75)), url('/images/background.jpg');
            background-attachment: fixed;
            background-position: center;
            background-size: cover;
            background-repeat: no-repeat;
            color: var(--accent); /* Fast alle Texte standardmäßig gelb */
            min-height: 100vh;
            margin: 0;
        }

        .leaderboard-container { max-width: 1000px; margin: 40px auto; }
        
        .glass-card {
            background: var(--bg-card) !important;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(251, 191, 36, 0.2) !important;
            border-radius: 20px;
        }

        /* Namen weiß lassen */
        .username-bright {
            color: #ffffff !important;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        /* Ränge behalten ihre eigene Farbe */
        .rank-name-bright {
            font-weight: 800;
            text-transform: uppercase;
            text-shadow: 0px 0px 3px rgba(0,0,0,1);
            letter-spacing: 0.5px;
        }

        /* Plätze auf Podium weiß für Kontrast */
        .podium-rank-text { color: white !important; opacity: 0.8; }

        .top-three { display: flex; justify-content: center; align-items: flex-end; gap: 20px; margin-bottom: 40px; padding-top: 40px; }
        .podium-card { padding: 20px; text-align: center; position: relative; transition: 0.3s; }
        .podium-card:hover { transform: translateY(-10px); border-color: var(--accent) !important; }
        
        .podium-1 { order: 2; width: 240px; height: 380px; border: 2px solid #fbbf24 !important; box-shadow: 0 0 30px rgba(251, 191, 36, 0.2); }
        .podium-2 { order: 1; width: 200px; height: 320px; }
        .podium-3 { order: 3; width: 200px; height: 320px; }

        .avatar-wrapper { position: relative; display: inline-block; margin-bottom: 15px; }
        .podium-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #fff; }
        .podium-1 .podium-avatar { width: 110px; height: 110px; border-color: #fbbf24; }
        
        .rank-badge-podium { position: absolute; bottom: -5px; right: -5px; width: 45px; height: 45px; object-fit: contain; z-index: 2; }

        /* Scroll-Idee für lange Listen */
        .leaderboard-scroll-area {
            max-height: 600px; /* Begrenzt die Höhe der Liste */
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) transparent;
        }
        .leaderboard-scroll-area::-webkit-scrollbar { width: 6px; }
        .leaderboard-scroll-area::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }

        /* Progress Bar Animation */
        .progress-custom { 
            height: 8px; 
            background: rgba(255,255,255,0.05); 
            border-radius: 10px; 
            overflow: hidden; 
            margin-top: 5px; 
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .progress-bar-animated {
            height: 100%;
            border-radius: 10px;
            position: relative;
            transition: width 1s ease-in-out;
            background-size: 30px 30px;
            background-image: linear-gradient(
                135deg, 
                rgba(255, 255, 255, .15) 25%, 
                transparent 25%, 
                transparent 50%, 
                rgba(255, 255, 255, .15) 50%, 
                rgba(255, 255, 255, .15) 75%, 
                transparent 75%, 
                transparent
            );
            animation: progress-move 2s linear infinite;
        }

        @keyframes progress-move {
            from { background-position: 0 0; }
            to { background-position: 30px 0; }
        }

        .rank-card { 
            background: rgba(255, 255, 255, 0.03); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            border-radius: 12px; 
            transition: all 0.4s ease; 
        }
        .rank-card:hover { transform: translateY(-5px); border-color: var(--accent); }
        .rank-icon-roadmap { width: 60px; height: 60px; object-fit: contain; transition: 0.3s; }
        
        .table { color: var(--accent) !important; }
        .table thead th { border-bottom: 2px solid rgba(251, 191, 36, 0.2); color: var(--accent); }
    </style>
</head>
<body>

<% 
// Ranking Logic bleibt gleich
const getRankInfo = (mins) => {
    const current = ranks.find(r => mins >= r.min) || ranks[ranks.length - 1];
    const nextIndex = ranks.indexOf(current) - 1;
    const next = nextIndex >= 0 ? ranks[nextIndex] : null;
    let progress = 100;
    if (next) progress = Math.floor(((mins - current.min) / (next.min - current.min)) * 100);
    return { current, next, progress };
};

const formatFullTime = (totalMins) => {
    const hours = Math.floor(totalMins / 60);
    const mins = Math.floor(totalMins % 60);
    return hours > 0 ? `${hours} Std. ${mins} Min.` : `${mins} Min.`;
};

function renderLeaderboard(userList, timeKey) { %>
    <% if(userList.length >= 1) { %>
    <div class="top-three">
        <% userList.slice(0, 3).forEach((user, index) => { 
            const info = getRankInfo(user[timeKey]);
        %>
            <div class="podium-card podium-<%= index + 1 %> glass-card">
                <div class="avatar-wrapper">
                    <img src="<%= user.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png' %>" class="podium-avatar">
                    <img src="/images/ranks/<%= info.current.img %>" class="rank-badge-podium">
                </div>
                <h4 class="mb-1 text-truncate username-bright"><%= user.username %></h4>
                <div class="rank-name-bright" style="color: <%= info.current.color %>; font-size: 0.75rem;"><%= info.current.name %></div>
                <div class="fw-bold live-timer mt-1" data-base="<%= user.totalMinutes %>" data-start="<%= user.isStreaming ? user.lastStreamStart : 'null' %>">
                    <%= formatFullTime(user[timeKey]) %>
                </div>
                <div class="podium-rank-text small mt-1">Platz <%= index + 1 %></div>
            </div>
        <% }) %>
    </div>
    <% } %>

    <div class="glass-card overflow-hidden">
        <table class="table align-middle mb-0">
            <thead class="bg-black bg-opacity-40">
                <tr>
                    <th class="ps-4 py-3" style="width: 80px;">#</th>
                    <th>User & Fortschritt</th>
                    <th class="text-end pe-4">Gesamtzeit</th>
                </tr>
            </thead>
        </table>
        <div class="leaderboard-scroll-area">
            <table class="table table-hover align-middle mb-0">
                <tbody>
                    <% userList.slice(3).forEach((user, index) => { 
                        const info = getRankInfo(user[timeKey]);
                    %>
                    <tr class="border-bottom border-white border-opacity-10">
                        <td class="ps-4 podium-rank-text" style="width: 80px;">#<%= index + 4 %></td>
                        <td class="py-3">
                            <div class="d-flex align-items-center">
                                <img src="<%= user.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png' %>" style="width: 40px; height: 40px; border-radius: 50%;" class="me-3 border border-warning">
                                <div class="flex-grow-1">
                                    <span class="username-bright"><%= user.username %></span>
                                    <div class="d-flex align-items-center mt-1">
                                        <img src="/images/ranks/<%= info.current.img %>" style="width: 20px; height: 20px; object-fit: contain;" class="me-2">
                                        <span class="rank-name-bright me-2" style="color: <%= info.current.color %>; font-size: 0.65rem;"><%= info.current.name %></span>
                                        <% if(info.next) { %>
                                            <span style="font-size: 0.6rem;" class="opacity-75">Noch <%= formatFullTime(info.next.min - user[timeKey]) %> bis <%= info.next.name %></span>
                                        <% } %>
                                    </div>
                                    <% if(info.next) { %>
                                    <div class="progress-custom">
                                        <div class="progress-bar-animated" style="width: <%= info.progress %>%; background-color: <%= info.current.color %>; box-shadow: 0 0 10px <%= info.current.color %>50;"></div>
                                    </div>
                                    <% } %>
                                </div>
                            </div>
                        </td>
                        <td class="text-end pe-4 fw-bold live-timer" data-base="<%= user.totalMinutes %>" data-start="<%= user.isStreaming ? user.lastStreamStart : 'null' %>">
                            <%= formatFullTime(user[timeKey]) %>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>
<% } %>

<div class="container leaderboard-container">
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold text-accent">STREAM RANKING</h1>
        <p class="text-uppercase" style="letter-spacing: 3px;"><%= guild.name %></p>
    </div>

    <% renderLeaderboard(allTimeLeaderboard, 'effectiveTotal'); %>

    <div class="mt-5 p-4 glass-card text-center">
        <h5 class="text-accent mb-4 fw-bold">ROLLEN ROADMAP</h5>
        <div class="row g-3 justify-content-center">
            <% [...ranks].reverse().forEach(r => { %>
                <div class="col-4 col-md-2">
                    <div class="rank-card p-2">
                        <img src="/images/ranks/<%= r.img %>" class="rank-icon-roadmap mb-1">
                        <div class="rank-name-bright" style="color: <%= r.color %>; font-size: 0.6rem;"><%= r.name %></div>
                        <div class="small opacity-75" style="font-size: 0.55rem;"><%= formatFullTime(r.min) %></div>
                    </div>
                </div>
            <% }) %>
        </div>
    </div>
</div>

<script>
    // Live Timer Script (unverändert)
    function formatTimeJS(totalMins) {
        const h = Math.floor(totalMins / 60);
        const m = Math.floor(totalMins % 60);
        return h > 0 ? h + " Std. " + m + " Min." : m + " Min.";
    }
    function updateLive() {
        const now = new Date();
        document.querySelectorAll('.live-timer').forEach(el => {
            const startStr = el.getAttribute('data-start');
            const base = parseInt(el.getAttribute('data-base'));
            if(startStr && startStr !== 'null') {
                const diff = Math.floor((now - new Date(startStr)) / 60000);
                if(diff >= 0) el.innerText = formatTimeJS(base + diff);
            }
        });
    }
    setInterval(updateLive, 10000);
    updateLive();
</script>
</body>
</html>
