<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings | <%= guild.name %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --accent: #fbbf24; 
            --accent-blue: #00d2ff;
            --bg-dark: #0a0a0f;
        }

        body {
            background-image: linear-gradient(rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.85)), url('/images/background.jpg');
            background-attachment: fixed;
            background-position: center;
            background-size: cover;
            color: white;
            min-height: 100vh;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        /* --- GLASSMOPHISM --- */
        .glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(10, 10, 15, 0.85) 100%) !important;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.12) !important;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .text-accent { color: var(--accent) !important; }
        
        /* --- TABLE STYLING --- */
        .table { --bs-table-bg: transparent; color: white !important; margin-bottom: 0; }
        .table thead th { 
            background: rgba(0,0,0,0.2);
            color: var(--accent) !important; 
            text-transform: uppercase; 
            font-size: 0.75rem; 
            letter-spacing: 1px; 
            border-bottom: 1px solid rgba(251, 191, 36, 0.2);
            padding: 15px;
        }
        .table tbody td { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* --- INPUTS & BUTTONS --- */
        .search-input, .adjust-input, .form-control, .form-select {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: white !important;
            border-radius: 10px;
            transition: 0.3s;
        }
        .search-input:focus, .form-control:focus {
            border-color: var(--accent) !important;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.2) !important;
        }

        .btn-cyber {
            background: var(--accent);
            color: black;
            font-weight: 700;
            border: none;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: 0.3s;
        }
        .btn-cyber:hover {
            background: white;
            box-shadow: 0 0 20px var(--accent);
            transform: translateY(-2px);
        }

        /* --- ANIMATIONS --- */
        .pulse-live {
            width: 8px; height: 8px;
            background: #ff0055;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 10px #ff0055;
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        .particles-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .particle { position: absolute; background: var(--accent); border-radius: 50%; opacity: 0.2; animation: floatUp 15s linear infinite; }
        @keyframes floatUp {
            0% { transform: translateY(110vh) translateX(0); opacity: 0; }
            50% { opacity: 0.2; }
            100% { transform: translateY(-10vh) translateX(50px); opacity: 0; }
        }

        .scroll-container { max-height: 650px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--accent) transparent; }
        .scroll-container::-webkit-scrollbar { width: 5px; }
        .scroll-container::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }
    </style>
</head>
<body>

<div class="particles-container" id="particles"></div>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-5 glass-card p-4">
        <div class="d-flex align-items-center">
            <% if(guild.icon) { %>
                <img src="https://cdn.discordapp.com/icons/<%= guild.id %>/<%= guild.icon %>.png" 
                     class="rounded-circle me-3" style="width: 60px; border: 2px solid var(--accent); box-shadow: 0 0 15px rgba(251, 191, 36, 0.3);">
            <% } %>
            <div>
                <h1 class="h3 mb-0 fw-bold text-white"><%= guild.name %></h1>
                <span class="text-accent small"><i class="fas fa-shield-halved me-1"></i> Admin Management Dashboard</span>
            </div>
        </div>
        <a href="/dashboard" class="btn btn-outline-light btn-sm px-4 rounded-pill"><i class="fas fa-chevron-left me-2"></i> Zur√ºck</a>
    </div>

    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="glass-card h-100 overflow-hidden">
                <div class="p-4 d-flex justify-content-between align-items-center" style="background: rgba(255,255,255,0.03);">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-users-gear text-accent me-2"></i> User-Verwaltung</h5>
                    <div class="position-relative">
                        <i class="fas fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-accent opacity-50"></i>
                        <input type="text" id="userSearch" class="form-control form-control-sm search-input ps-5" placeholder="Mitglied suchen...">
                    </div>
                </div>
                
                <div class="table-responsive scroll-container">
                    <table class="table table-hover align-middle" id="userTable">
                        <thead>
                            <tr>
                                <th class="ps-4">Mitglied</th>
                                <th class="text-center">Streaming-Zeit</th>
                                <th class="text-center">Quick-Edit</th>
                                <th class="text-end pe-4">Aktion</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% trackedUsers.forEach((user) => { 
                                let displayMinutes = user.totalMinutes;
                                if (user.isStreaming && user.lastStreamStart) {
                                    const sessionMins = Math.floor((new Date() - new Date(user.lastStreamStart)) / 60000);
                                    displayMinutes += sessionMins;
                                }
                            %>
                            <tr class="user-row">
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="position-relative me-3">
                                            <img src="<%= user.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png' %>" 
                                                 style="width: 42px; height: 42px; border-radius: 50%; border: 2px solid <%= user.isStreaming ? '#ff0055' : 'rgba(255,255,255,0.1)' %>;">
                                            <% if(user.isStreaming) { %>
                                                <span class="position-absolute bottom-0 end-0 pulse-live"></span>
                                            <% } %>
                                        </div>
                                        <div>
                                            <div class="fw-bold text-white username-text"><%= user.displayName %></div>
                                            <div class="small opacity-50">@<%= user.username %></div>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="text-accent fw-bold fs-5 live-timer-container"
                                          data-base="<%= user.totalMinutes %>"
                                          data-start="<%= user.isStreaming && user.lastStreamStart ? user.lastStreamStart.toISOString() : 'null' %>">
                                        <%= displayMinutes %>
                                    </span> 
                                    <span class="small opacity-50 text-uppercase" style="font-size: 0.6rem;">min</span>
                                </td>
                                <td class="text-center">
                                    <form action="/dashboard/<%= guild.id %>/adjust-time" method="POST" class="d-inline-flex">
                                        <input type="hidden" name="userId" value="<%= user.userId %>">
                                        <input type="number" name="minutes" class="adjust-input me-2 text-center" style="width: 70px;" placeholder="+/-">
                                        <button type="submit" class="btn btn-sm btn-dark border-secondary"><i class="fas fa-save"></i></button>
                                    </form>
                                </td>
                                <td class="text-end pe-4">
                                    <form action="/dashboard/<%= guild.id %>/delete-user" method="POST" onsubmit="return confirm('Statistik unwiderruflich l√∂schen?')">
                                        <input type="hidden" name="userId" value="<%= user.userId %>">
                                        <button class="btn btn-link text-danger p-0" title="User entfernen"><i class="fas fa-trash-can"></i></button>
                                    </form>
                                </td>
                            </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="glass-card p-4 mb-4">
                <h5 class="mb-4 text-accent d-flex align-items-center">
                    <i class="fas fa-trophy me-2"></i> Rank-Rewards
                </h5>
                <form action="/dashboard/<%= guild.id %>/save" method="POST" class="mb-4">
                    <div class="mb-3">
                        <label class="small opacity-50 mb-1">Minuten-Meilenstein</label>
                        <input type="number" name="minutes" class="form-control form-control-sm" placeholder="z.B. 1440" required>
                    </div>
                    <div class="mb-3">
                        <label class="small opacity-50 mb-1">Belohnungs-Rolle</label>
                        <select name="roleId" class="form-select form-select-sm">
                            <% roles.forEach(role => { %>
                                <option value="<%= role.id %>">@<%= role.name %></option>
                            <% }) %>
                        </select>
                    </div>
                    <button class="btn btn-cyber btn-sm w-100 shadow-sm">Hinzuf√ºgen</button>
                </form>

                <div class="reward-list">
                    <% config.rewards.forEach((r, i) => { %>
                        <div class="d-flex justify-content-between align-items-center p-3 mb-2 rounded bg-black bg-opacity-25 border-start border-3 border-accent">
                            <div>
                                <div class="fw-bold small"><%= r.minutesRequired %> Min.</div>
                                <span class="badge bg-dark border border-secondary text-accent">@<%= r.roleName %></span>
                            </div>
                            <form action="/dashboard/<%= guild.id %>/delete-reward" method="POST">
                                <input type="hidden" name="rewardIndex" value="<%= i %>">
                                <button class="btn btn-link text-danger p-0 ms-2"><i class="fas fa-times"></i></button>
                            </form>
                        </div>
                    <% }) %>
                </div>
            </div>

            <div class="glass-card p-4">
                <h5 class="mb-3 text-accent"><i class="fas fa-satellite-dish me-2"></i> Tracking-Kan√§le</h5>
                <p class="small opacity-50">W√§hle die Voice-Kan√§le aus, in denen gestreamt werden darf.</p>
                <form action="/dashboard/<%= guild.id %>/save-channels" method="POST">
                    <div class="channel-selector mb-3 p-3 bg-black bg-opacity-25 rounded border border-white border-opacity-10" style="max-height: 250px; overflow-y: auto;">
                        <% channels.forEach(ch => { %>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="channels" value="<%= ch.id %>" id="ch-<%= ch.id %>"
                                <%= config.allowedChannels.includes(ch.id) ? 'checked' : '' %>>
                                <label class="form-check-label small" for="ch-<%= ch.id %>">
                                    <%= ch.type === 4 ? 'üìÅ' : 'üîä' %> <%= ch.name %>
                                </label>
                            </div>
                        <% }) %>
                    </div>
                    <button class="btn btn-outline-warning btn-sm w-100 fw-bold">Kan√§le speichern</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Partikel Effekt Generator
    const particlesContainer = document.getElementById('particles');
    for (let i = 0; i < 30; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        const size = Math.random() * 4 + 2 + 'px';
        p.style.width = size;
        p.style.height = size;
        p.style.left = Math.random() * 100 + 'vw';
        p.style.animationDelay = Math.random() * 15 + 's';
        p.style.animationDuration = Math.random() * 10 + 10 + 's';
        particlesContainer.appendChild(p);
    }

    // Live Suche
    document.getElementById('userSearch').addEventListener('keyup', function() {
        let filter = this.value.toLowerCase();
        let rows = document.querySelectorAll('.user-row');
        rows.forEach(row => {
            let name = row.querySelector('.username-text').innerText.toLowerCase();
            row.style.display = name.includes(filter) ? '' : 'none';
        });
    });

    // Live Minuten Update
    function updateLiveMinutes() {
        const now = new Date();
        document.querySelectorAll('.live-timer-container').forEach(el => {
            const startStr = el.getAttribute('data-start');
            const baseMins = parseInt(el.getAttribute('data-base'));
            if (startStr && startStr !== 'null') {
                const startTime = new Date(startStr);
                const sessionMinutes = Math.floor((now - startTime) / 60000);
                if (sessionMinutes >= 0) el.innerText = baseMins + sessionMinutes;
            }
        });
    }
    setInterval(updateLiveMinutes, 10000);
</script>

</body>
</html>
